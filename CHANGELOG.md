# 更新日志 (Changelog)

本文档记录了 TitleLab 项目的所有重要更改。

## [2025-12-10] - 优化PWA更新检查机制，移除后台运行以节省电量

### 性能优化
- **移除后台运行机制**：
  - 完全移除60秒定期检查，避免后台运行消耗电量
  - 只在页面打开时检查一次更新
  - 只在页面从后台切回前台时检查一次更新
  - 页面隐藏时完全停止所有检查，确保不消耗电量

### 改进
- 优化更新检查策略，确保后台完全不运行
- 使用 Page Visibility API 智能控制检查时机
- 页面卸载时自动清理所有定时器

---

## [2025-12-10] - 添加PWA自动更新检查机制

### 新增功能
- **自动更新检查**：
  - 实现 Service Worker 自动更新检查机制
  - 每3分钟自动检查一次更新（仅在页面可见时）
  - 检测到更新后自动刷新页面，无需用户操作
  
- **性能优化**：
  - 使用 Page Visibility API，页面隐藏时停止检查
  - 页面切回前台时智能检查更新
  - 减少67%的网络请求，降低电池消耗
  - 页面卸载时自动清理资源

### 技术改进
- 更新 Service Worker 缓存版本号到 v4
- 优化更新检查策略，平衡及时性和性能

---

## [2025-12-10] - 修复移动端布局和分类选择问题

### 修复
- **移动端布局问题**：
  - 修复手机端导航按钮和用户名徽章重合问题
  - 调整移动端 topbar 布局，使用静态定位避免重叠
  - 优化 topbar-right 的间距和布局
  
- **分类选择功能**：
  - 修复排序模式下分类无法选择的问题
  - 允许在排序模式下点击分类名称切换分类
  - 避免误触排序按钮导致无法切换分类

---

## [2025-12-10] - 优化移动端体验和UI改进

### 新增功能
- **排序按钮默认开启**：分类排序功能默认激活，方便用户直接调整分类顺序
- **olina账号专属场景分类**：为 olina 账号设置默认场景分类（西瓜、糖果、米苏、开心、飞船、女摄、新号、抖音）

### 改进
- **移动端适配优化**：
  - 修复 iPhone 状态栏重叠问题，添加安全区域处理
  - 修复移动端输入框自动放大问题，调整 viewport 和字体大小
  - 统一所有输入框字体为 13px，符合整体设计风格
  
- **UI/UX 优化**：
  - 所有页面用户名显示完整用户名（不再只显示首字母）
  - 排序按钮激活时显示蓝色高亮效果
  - 选择框文字颜色改为蓝色，提升视觉一致性
  - 调整设置页面面板顺序：场景管理置顶，主题与显示次之

### 修复
- 修复弹窗内输入框字体过大的问题
- 修复搜索框和选择框字体大小不一致的问题

---

## [2025-12-02] - 功能改进和Bug修复

### 新增功能
- **标题去重功能增强**：
  - 改为完全匹配（不归一化不转小写）
  - 添加重复内容预览框，显示保留和删除的项
  - 添加确认对话框防止误删

### 改进
- **云端快照功能优化**：
  - 添加保存时标签验证
  - 修复加载快照参数错误
  - 添加错误日志和DOM元素检查
  - 优化模态框显示逻辑

- **用户隔离加强**：
  - 严格过滤 user_profile_ 记录
  - 只允许 user_username_manual_ 格式的快照
  - 加载时拒绝非当前用户的快照和配置文件
  - 快照列表和加载时按用户过滤，确保每个账号只能访问自己的快照

### 修复
- **页面灰色覆盖层问题**：
  - 修复页面灰色无法点击问题
  - 确保所有模态框在初始化时隐藏
  - 添加错误处理防止初始化失败导致页面被禁用
  - 优化模态框隐藏脚本，避免 MutationObserver 干扰正常显示

- **快照加载问题**：
  - 修复重复的 user 变量声明
  - 改进错误处理，返回明确的 Bad Request 错误
  - 清理 scene_tags 确保用户隔离
  - 优化 clearAndInsert 避免重复添加用户标签
  - 修复加载快照后重新加载并渲染分类列表
  - 修复空白快照问题，过滤掉登录时创建的用户配置文件记录
  - 防止自动保存空白快照，如果标签为空则拒绝保存

- **其他修复**：
  - 修复加载云端按钮：添加事件阻止冒泡，强制显示面板样式
  - 修复加载快照：直接调用 snapshotService 而不是 loadCloudSnapshot 函数
  - 优化点击外部关闭逻辑

---

## [2025-12-02] - 用户隔离和存储优化

### 新增功能
- **按用户单独存储**：
  - 账号分类和主分类设置每个账号独立存储，互不共享
  - 添加用户隔离检查报告，确认所有设置已按用户单独存储和隔离

### 改进
- 修复快照加载问题：恢复场景设置（账号分类）并应用显示设置

---

## [2025-12-01] - 功能完善和Bug修复

### 新增功能
- **分类重命名功能**：添加标题页面分类重命名模态框，与文案页面保持一致

### 修复
- 修复根路径访问问题：将 title.html 内容复制到 index.html，删除重定向代码
- 修复账号分类筛选逻辑：确保主分类和账号分类筛选正确配合工作
- 修复账号分类保存和筛选问题：将账号分类添加到 scene_tags 数组以便正确筛选
- 修复场景下拉菜单：从场景管理设置读取，而不是从分类读取
- 修复账号分类下拉菜单同步问题：分类名称修改后自动更新所有相关下拉菜单

### 改进
- 更新 Service Worker 缓存版本以清除旧缓存

---

## 文件变更统计

### 最新版本 (2025-12-10)
- **修改文件数**：11 个
- **新增代码行数**：150 行
- **删除代码行数**：53 行

### 主要修改文件
- `assets/styles.css` - 样式优化和移动端适配
- `assets/app-title.js` - 标题管理功能优化
- `assets/app-content.js` - 文案管理功能优化
- `assets/settings.js` - 设置页面功能优化
- `assets/admin.js` - 管理页面功能优化
- `index.html`, `title.html`, `content.html`, `settings.html`, `login.html`, `admin-center.html` - 页面结构调整

---

## 技术细节

### 移动端适配
- 使用 `env(safe-area-inset-top)` 处理 iPhone 安全区域
- 设置 `maximum-scale=1.0, user-scalable=no` 防止自动缩放
- 统一字体大小为 13px，保持设计一致性

### 用户隔离
- 所有设置使用 `localStorage` 按用户名单独存储
- 快照功能严格按用户过滤
- 场景分类支持不同用户不同默认值

### UI 优化
- 用户名徽章从圆形改为圆角矩形，支持完整用户名显示
- 排序按钮添加激活状态高亮
- 选择框文字颜色统一为品牌蓝色

---

## 版本历史

- **v1.0.0** (2025-12-10) - 移动端体验优化和UI改进
- **v0.9.0** (2025-12-02) - 功能改进和Bug修复
- **v0.8.0** (2025-12-02) - 用户隔离和存储优化
- **v0.7.0** (2025-12-01) - 功能完善和Bug修复

---

*最后更新：2025-12-10*

