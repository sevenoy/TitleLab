<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>登录 / 注册 - XHSPHONE</title>
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="TitleLab" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#ffffff" />
    <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="assets/styles.css" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon/icon-512.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon/icon-192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="icon/icon-512.png" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .login-container {
      background: #ffffff;
      border-radius: 20px;
      padding: 32px 28px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .logo { text-align: center; margin-bottom: 20px; }
    .logo h1 { font-size: 28px; color: #1990FF; margin-bottom: 6px; }
    .logo p { color: #888; font-size: 13px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
    .form-group input { width: 100%; padding: 12px 16px; border: 2px solid #e5e5ea; border-radius: 10px; font-size: 16px; transition: all 0.3s; }
    .form-group input:focus { outline: none; border-color: #1990FF; box-shadow: 0 0 0 3px rgba(25, 144, 255, 0.1); }
    .btn-submit { width: 100%; padding: 14px; background: #1990FF; color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-submit:hover { background: #1576d8; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(25, 144, 255, 0.4); }
    .btn-submit:active { transform: translateY(0); }
    #loginToast { margin-top: 12px; padding: 10px 12px; border-radius: 8px; font-size: 13px; display: none; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo">
      <h1>TitleLab</h1>
      <p>标题管理</p>
    </div>
    <div class="form-group">
      <label>用户名</label>
      <input id="loginUsername" type="text" placeholder="请输入用户名" />
    </div>
    <div class="form-group">
      <label>密码</label>
      <input id="loginPassword" type="password" placeholder="请输入密码" />
    </div>
    <button id="btnLogin" class="btn-submit">登录</button>
    <div id="loginToast"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js"></script>
  <script src="assets/supabase.js"></script>
  <script src="assets/pwa.js"></script>
  <script>
    function showMsg(msg, ok) {
      const el = document.getElementById('loginToast');
      if (!el) return;
      el.textContent = msg;
      el.style.display = 'block';
      el.style.background = ok ? '#dcfce7' : '#fee2e2';
      el.style.color = ok ? '#166534' : '#b91c1c';
      setTimeout(() => { el.style.display = 'none'; }, 1800);
    }

    function getCurrentUser() {
      try { const raw = localStorage.getItem('current_user_v1'); return raw ? JSON.parse(raw) : null; } catch (_) { return null; }
    }

    async function sha256Hex(s) {
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(s));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function userTag(u) { return `user:${u}`; }

    async function recordUserProfile(username, role) {
      try {
        const client = window.supabaseClient;
        if (!client) return;
        const row = { key: `user_profile_${username}`, payload: { username, role, last_login_at: new Date().toISOString() }, updated_at: new Date().toISOString() };
        await client.from('snapshots').upsert([row], { onConflict: 'key' });
      } catch (_) { /* ignore */ }
    }

    // 允许登录的用户列表
    const ALLOWED_USERS = {
      'sevenoy': { role: 'admin', password: 'jiajia' },
      'olina': { role: 'user', password: 'jiajia' }
    };

    // 页面加载时检查是否已登录，如果已登录则自动跳转
    window.addEventListener('DOMContentLoaded', () => {
      const currentUser = getCurrentUser();
      if (currentUser && currentUser.username && ALLOWED_USERS[currentUser.username]) {
        // 验证用户是否仍在允许列表中
        window.location.href = 'title.html';
      }
    });

    document.getElementById('btnLogin').addEventListener('click', async () => {
      const u = document.getElementById('loginUsername').value.trim();
      const p = document.getElementById('loginPassword').value || '';
      
      if (!u) { 
        showMsg('请输入用户名', false); 
        return; 
      }

      // 检查用户是否在允许列表中
      const userConfig = ALLOWED_USERS[u];
      if (!userConfig) {
        showMsg('该用户无权登录', false);
        return;
      }

      // 验证密码
      if (p !== userConfig.password) {
        showMsg('密码错误', false);
        return;
      }

      // 登录成功，保存用户信息
      const profile = { username: u, role: userConfig.role };
      localStorage.setItem('current_user_v1', JSON.stringify(profile));
      try { 
        await recordUserProfile(u, userConfig.role); 
      } catch (_) {}
      
      showMsg('登录成功', true);
      setTimeout(() => { 
        window.location.href = 'title.html'; 
      }, 400);
    });
  </script>
</body>
</html>